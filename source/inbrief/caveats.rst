.. _caveats:

************************
Current caveats for MARX
************************

General Caveats for Monte-Carlo simulations
===========================================
|marx| is a Monte-Carlo tool, that means it uses random numbers when simulating
the X-ray flux and the response for Chandra. For example, if the source
spectrum indicates a constant flux between 1 and 10 keV, |marx| will create
photons randomly from this interval. If only a small number of photons is used
in a simulation, it is possible (though not very likely) that a lot more
photons are softer than 5 keV. For a large number of photons, the result will
eventually converge to a constant spectrum.

Random numbers are used for all interactions in |marx|, not only when selecting
the energy of the photons, but also to see where in the aperture it enters
Chandra, how it bounces of the mirrors, how it defracts from the gratings, etc.
Thus, even if the physical model for a source is perfect, the simulated
spectrum and a Chandra observation will differ.

Furthermore, this means that two |marx| simulations with the same input
parameters will give different results, unless they use the same sequence of
random numbers (set the parameter :par:`RandomSeed` to a positive number to
obtain the same sequence of random numbers).


Spatial Dependence of the Quantum Efficiency
============================================
The current version of |marx| does not incorporate the QE uniformity
maps and bad-pixel files that give rise to spatial variation in the
QE.  Consequently, exposure maps and ARFs created by default in \ciao
will be inconsistent with MARX simulations.  For simulated
observations on ACIS-S3, this difference should be small since spatial
variations in the QE are relatively small on this CCD. However,
simulated ACIS-I observations will be effected to a greater degree due
to the larger QE variations produced by CTI effects.

For users of `CIAO`_ 2.3 and higher, the tools :ciao:`mkarf` and :ciao:`mkinstmap`
include the ability to turn off the QE uniformity maps through the use
of :ciao:`ardlib` qualifiers.  For example, a calling sequence like::

    unix%  mkarf detsubsys="ACIS-7;uniform;bpmask=0" ......

will produce an ARF on ACIS-7 (ACIS-S3) but with bad pixel processing
disabled (``bpmask=0``) and without the effects of the CALDB
non-uniformity files included.  The resulting ARF will be consistent
with a |marx| simulation.  A similar call to :ciao:`mkinstmap` can
be used in conjunction with :ciao:`mkexpmap` to create exposure maps
appropriate for |marx| simulations.  This technique is illustrated in :ref:`ex-ciao`.


ACIS Response Functions
========================
`CIAO`_ includes a couple of different tools for creating ACIS response
matrices (RMFs): :ciao:`mkacisrmf` and :ciao:`mkrmf`.  The :ciao:`mkacisrmf` tool is
designed for the analysis of CTI corrected data, whereas :ciao:`mkrmf`
creates an RMF for non-CTI corrected data.  The response algorithm
implemented in |marx| is based upon the calibration data used by
:ciao:`mkrmf`.  Hence the PHAs generated by |marx| for the ACIS detector
represent non-CTI corrected values and as such are consistent with the
responses generated by :ciao:`mkrmf` but not with :ciao:`mkacisrmf`.  Consequently,
users should continue to use the :ciao:`mkrmf` to create RMFs that
are consistent with their |marx| simulations.  More information about
using :ciao:`mkrmf` in the context of a |marx| simulation may be found in :ref:`ex-ciao`.

Alternatively, :marxtool:`marxrsp` may be used to apply *any* RMF to a |marx|
simulation with the caveat that the mapping from photon energy to PHA
does not vary over the detector.

Mismatch between the FEF-based response and the CALDB order-sorting tables
==========================================================================
As mentioned above, |marx| generates non-CTI corrected PHA values. This
is accomplished by mapping the incident photon energy to a PHA value
using a probability from derived from the most recent non-CTI
calibration data (CALDB ``acisD2000-01-29fef_phaN0005.fits``).  The CIAO
tool :ciao:`tg_resolve_events` assigns a diffracted order to each event
by comparing the event's ACIS energy to its dispersion coordinate.
The ACIS energy window for a particular order is tabulated in a
CALDB order-sorting table (OSIP).

For non-CTI corrected data, the CALDB order sorting table
(``acisD2000-01-29osipN0006.fits``) was computed using a much older
version of the non-CTI response data
(``acisD2000-01-29fef_phaN0002.fits``).  These files
(``acisD2000-01-29fef_phaN0002.fits`` vs ``acisD2000-01-29fef_phaN0005.fits``)
differ mainly in the region around the Si K edge (~1.8 keV).  As such,
a comparison of a |marx| spectrum with the expected spectrum
of the input model will show strong systematic residuals near 1.8 keV.

.. todo::

   To properly account for this effect, :ciao:`tg_resolve_events` should use
   an order-sorting table derived from ``acisD2000-01-29fef_phaN0005.fits``.
   Such a table can be found
   \href{caldb/acisD2000-01-29osipN0007.fits}{here}.  To make use of it,
   run *both* :ciao:`tg_resolve_events` and :ciao:`mkgarf` with the ``osipfile``
   parameter set to the name of the file.


ISIS Pileup Fitting Kernel
==========================

The default parameters for the pileup fitting kernel in `ISIS`_, but also in
`Sherpa`_ and `XSpec`_ have been
calibrated for point source extractions. Specifically, the values
correspond to a circular extraction region 4 ACIS pixels in radius.
Although |marx| can be used to include the effects of photon
pileup for any arbitrary spatial and spectral source model, the
fitting kernel may need to be adjusted for larger extraction
regions. In particular, the ``psffrac`` parameter represents the
fraction of the Chandra PSF contained within the extraction region and
may need to be increased for larger regions. Note, however, that for
real data, larger extraction regions will include a higher fraction of
unpiled background photons complicating the fitting of the piled
source spectrum.  As such, it is recommended that this value be
allowed to vary during the spectral fit.  See the `ISIS`_ manual for
more discussion of the pileup fitting kernel.

Chandra Aimpoint Drift
======================

|marx| does not currently take into account of temporal drift in 
Chandra's HRMA aimpoint. Fortunately the effect of the drift is 
generally negligible and should not be a concern for Chandra proposers. 

